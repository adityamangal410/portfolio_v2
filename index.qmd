---
title: "Blog Posts"
jupyter: python3
execute:
  echo: false
---

```{python}
import glob, os, re
from html import escape
from IPython.display import HTML, display


def parse_front_matter(path):
    yaml = {}
    with open(path, encoding='utf-8') as fh:
        lines = fh.readlines()
    if not lines or lines[0].strip() != '---':
        return yaml
    for line in lines[1:]:
        if line.strip() == '---':
            break
        if ':' not in line:
            continue
        key, val = line.split(':', 1)
        yaml[key.strip()] = val.strip().strip('"').strip("'")
    return yaml


def extract_first_local_image(path):
    """Return the first image path inside the post that is not an external URL."""
    with open(path, encoding='utf-8') as fh:
        text = fh.read()
    if text.startswith('---'):
        parts = text.split('---', 2)
        if len(parts) == 3:
            text = parts[2]
    # search for HTML <img> tags
    for m in re.finditer(r'<img[^>]+src="([^"]+)"', text):
        src = m.group(1)
        if not src.startswith('http://') and not src.startswith('https://'):
            return src
    # search for Markdown images
    for m in re.finditer(r'!\[[^\]]*\]\(([^)]+)\)', text):
        src = m.group(1)
        if not src.startswith('http://') and not src.startswith('https://'):
            return src
    return None


posts = []
for f in glob.glob('posts/*.qmd'):
    if os.path.basename(f) == 'index.qmd':
        continue
    meta = parse_front_matter(f)
    slug = os.path.splitext(os.path.basename(f))[0]
    url = f'posts/{slug}.html'
    image = extract_first_local_image(f)
    if not image:
        image = meta.get('coverImage') or meta.get('thumbnailImage', '')
    posts.append(
        (
            meta.get('date', ''),
            meta.get('title', slug),
            meta.get('summary', ''),
            url,
            image,
        )
    )

posts.sort(reverse=True)

blocks = []
for date, title, summary, url, image in posts:
    img_tag = f'<img src="{escape(image)}" alt="{escape(title)}">' if image else ''
    blocks.append(
        f'''<div class="post-block">
  <div class="post-info">
    <h2><a href="{escape(url)}">{escape(title)}</a></h2>
    <p>{escape(summary)}</p>
  </div>
  {img_tag}
</div>'''
    )

display(HTML('\n'.join(blocks)))
```

